# amanita.breakcorn.ru

Видео-плеер с автоматической очисткой памяти для непрерывного воспроизведения YouTube и Vimeo контента.

## Проблема решена: Переполнение памяти

В версии 0.0.10+ исправлена проблема переполнения памяти при длительном просмотре YouTube видео.

### Реализованные решения:

1. **Периодическое пересоздание плеера** - каждые 5 видео плеер полностью уничтожается и создается заново
2. **Принудительная очистка iframe** - YouTube embed элементы корректно удаляются из DOM
3. **Мониторинг памяти** - автоматическое отслеживание потребления памяти каждые 30 секунд
4. **Чередование провайдеров** - приоритет отдается смене YouTube ↔ Vimeo для лучшей очистки ресурсов
5. **Принудительная сборка мусора** - для браузеров с поддержкой manual GC

### Отладка и мониторинг:

**Мониторинг памяти:**
- `Memory: XXmb / XXmb` каждые 30 секунд
- `Recreating player for memory cleanup...` - пересоздание плеера

**Watchdog мониторинг:**
- `Watchdog: time=Xs, duration=Xs, paused=false/true` - каждые 3 секунды
- `Video stuck at Xs - not starting` - обнаружено зависание
- `Video never started! Triggering recovery...` - запуск автовосстановления
- `Video disappeared but audio continues` - обнаружен postMessage проблема
- `Caught postMessage error, ignoring` - перехваченная cross-origin ошибка
- `Gentle/Forceful cleanup` - тип очистки iframe

### Новое в 0.0.13+: Защита от PostMessage ошибок:

- **Перехват postMessage ошибок** - предотвращает краши от cross-origin конфликтов
- **Мягкая очистка iframe** - сохраняет YouTube связь, принудительная только при критических ошибках
- **Обнаружение пропавшего видео** - автоматическое восстановление когда видео исчезает, а звук остается
- **Адаптивный watchdog** - учащает проверки до 1с при проблемах
- **Безопасные обработчики** - все события обернуты в try-catch

### Предыдущее в 0.0.12+: Анти-зависание Watchdog система:

- **Обнаружение тихих зависаний** - watchdog отслеживает currentTime каждые 3 секунды
- **Автоматическое восстановление** - переход к следующему видео через 9-12 секунд без прогресса
- **Двойная проверка** - отдельные счетчики для currentTime=0 и застряваний на любом времени
- **Моментальное восстановление** - watchdog ошибки восстанавливаются через 500мс

### Предыдущее в 0.0.11+: Автоматическое самовосстановление:

- **Обнаружение ошибок** - автоматический переход к следующему видео при ошибках загрузки
- **Таймаут загрузки** - 15 секунд максимум на загрузку видео
- **Мануальный пропуск** - пробел, клавиша N или клик по экрану
- **Проверка здоровья** - каждую минуту проверяет, не застряло ли видео
- **Умное чередование** - смена провайдера только при множественных ошибках

### Управление:

- **Пробел** - следующее видео
- **Клавиша N** - следующее видео  
- **Клик по экрану** - следующее видео (но не на контролы)

### Настройки (в коде):

- `MAX_VIDEOS_BEFORE_RECREATE = 5` - частота пересоздания плеера
- `MAX_CONSECUTIVE_FAILURES = 3` - максимум ошибок подряд до пересоздания
- `VIDEO_LOAD_TIMEOUT = 15000` - таймаут загрузки в мс
- `PREFER_PROVIDER_ALTERNATION = false` - отключено, не мешает моноисточникам
- `WATCHDOG_CHECK_INTERVAL = 3000` - интервал проверок watchdog в мс
- `MAX_STUCK_CHECKS = 3` - проверок обычного зависания
- `MAX_ZERO_TIME_CHECKS = 4` - проверок для currentTime=0
