# Автоматические тесты для Видеоплеера

Этот документ описывает автоматические тесты для веб-приложения видеоплеера amanita.breakcorn.ru.

## Обзор системы тестирования

Система тестирования построена на Python с использованием pytest и Selenium для автоматизации браузера. Тесты проверяют:

- ✅ Структуру HTML страницы и загрузку ресурсов
- ✅ JavaScript функциональность и API
- ✅ Воспроизведение видео и переключение между видео
- ✅ Управление памятью и предотвращение утечек
- ✅ Производительность и время отклика
- ✅ Обработку ошибок и восстановление
- ✅ Совместимость с различными браузерами

## Структура тестов

```
tests/
├── conftest.py                 # Общие фикстуры pytest
├── unit/                      # Модульные тесты
│   ├── test_page_structure.py    # Тесты структуры страницы
│   └── test_javascript_functions.py # Тесты JS функций
├── integration/               # Интеграционные тесты
│   ├── test_video_player.py     # Тесты видеоплеера
│   └── test_memory_management.py # Тесты управления памятью
├── performance/               # Тесты производительности
│   └── test_performance.py      # Нагрузочные тесты
├── fixtures/                  # Тестовые данные
│   └── test_data.py            # Константы и данные для тестов
└── utils/                     # Утилиты для тестирования
    └── test_helpers.py          # Вспомогательные функции
```

## Установка и настройка

### Предварительные требования

- Python 3.9+
- Chrome или Chromium браузер
- ChromeDriver (устанавливается автоматически)

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Зависимости включают:

- `pytest` - фреймворк для тестирования
- `selenium` - автоматизация браузера
- `webdriver-manager` - автоматическое управление драйверами
- `pytest-html` - HTML отчеты
- `pytest-cov` - покрытие кода
- `psutil` - мониторинг системных ресурсов

## Запуск тестов

### Запуск всех тестов

```bash
pytest
```

### Запуск определенной категории тестов

```bash
# Только модульные тесты
pytest tests/unit/ -v

# Только интеграционные тесты  
pytest tests/integration/ -v

# Только тесты производительности
pytest tests/performance/ -v
```

### Запуск по маркерам

```bash
# Только тесты браузера
pytest -m browser

# Только тесты памяти
pytest -m memory

# Только быстрые тесты (исключить медленные)
pytest -m "not slow"

# Только тесты производительности
pytest -m performance
```

### Запуск с локальным сервером

```bash
# Запустить HTTP сервер в отдельном терминале
python -m http.server 8000

# В другом терминале запустить тесты
BASE_URL=http://localhost:8000 pytest
```

## Конфигурация тестов

### Переменные окружения

- `BASE_URL` - URL для тестирования (по умолчанию: http://localhost:8000)
- `CI` - режим CI (включает headless режим браузера)
- `BROWSER` - тип браузера (chrome, firefox)
- `TEST_TIMEOUT` - таймаут для тестов (секунды)

### Пример:

```bash
BASE_URL=https://amanita.breakcorn.ru CI=true pytest
```

## Типы тестов

### 1. Модульные тесты (Unit Tests)

**test_page_structure.py:**
- Проверка заголовка страницы
- Наличие элемента плеера
- Загрузка JavaScript библиотек
- Структура массива видео
- CSS стили
- Атрибуты плеера

**test_javascript_functions.py:**
- Инициализация глобальных переменных
- Константы видеоплеера
- Наличие всех необходимых функций
- Обработка ошибок консоли

### 2. Интеграционные тесты (Integration Tests)

**test_video_player.py:**
- Загрузка начального видео
- Переключение на следующее видео
- Управление клавиатурой (пробел, N)
- Клик для переключения видео
- Чередование провайдеров (YouTube/Vimeo)
- Множественные переходы
- Восстановление после ошибок

**test_memory_management.py:**
- Активность мониторинга памяти
- Пересоздание плеера после лимита видео
- Очистка памяти при пересоздании
- Очистка iframe элементов
- Эффективность watchdog по памяти
- Очистка после множественных ошибок
- Стабильность памяти в долгосрочной работе

### 3. Тесты производительности (Performance Tests)

**test_performance.py:**
- Время загрузки страницы
- Время загрузки видео
- Производительность переходов между видео
- Границы использования памяти
- Производительность DOM манипуляций
- Влияние watchdog на производительность
- Производительность консольного логирования
- Использование CPU

## Отчеты и мониторинг

### HTML отчеты

```bash
pytest --html=reports/report.html --self-contained-html
```

Отчет сохраняется в `reports/report.html` с подробной информацией о прохождении тестов.

### Покрытие кода

```bash
pytest --cov=. --cov-report=html:reports/coverage
```

Отчет о покрытии сохраняется в `reports/coverage/index.html`.

### Параллельные тесты

```bash
pytest -n auto  # Автоматическое определение числа процессов
pytest -n 4     # Запуск на 4 процессах
```

## Continuous Integration (CI)

Система настроена для автоматического запуска в GitHub Actions при:

- Push в ветки main, develop, sketch-wip
- Pull Request в main, develop
- По расписанию (ежедневно в 2:00 UTC)

### Матрица тестирования CI:

- **Python версии:** 3.9, 3.10, 3.11, 3.12
- **Браузеры:** Chrome, Firefox (для основных веток)
- **Окружения:** Ubuntu Latest

### Этапы CI:

1. **Модульные тесты** - быстрые тесты структуры и функций
2. **Интеграционные тесты** - тесты функциональности плеера
3. **Тесты производительности** - проверка производительности
4. **Совместимость браузеров** - тестирование в разных браузерах
5. **Сканирование безопасности** - проверка зависимостей
6. **Развертывание** - подготовка пакета для развертывания

## Отладка тестов

### Включение подробного вывода

```bash
pytest -v -s  # Подробный вывод с print statements
```

### Остановка на первой ошибке

```bash
pytest -x  # Остановиться на первой неудаче
```

### Запуск только неудачных тестов

```bash
pytest --lf  # Last failed - только неудачные тесты
```

### Скриншоты при ошибках

Тесты автоматически создают скриншоты при ошибках (см. `BrowserHelpers.take_screenshot_on_failure`).

### Логи браузера

```python
# В тестах доступны логи браузера
logs = video_player_helper.get_console_logs()
for log in logs:
    print(f"Console: {log['level']} - {log['message']}")
```

## Добавление новых тестов

### 1. Создание нового тестового файла

```python
import pytest
from selenium.webdriver.common.by import By

@pytest.mark.browser  # Добавить подходящие маркеры
class TestNewFeature:
    """Описание тестового класса."""
    
    def test_new_functionality(self, loaded_page, video_player_helper):
        """Описание теста."""
        # Ваш тестовый код
        assert True
```

### 2. Использование фикстур

- `loaded_page` - браузер с загруженной страницей
- `video_player_helper` - помощник для работы с видеоплеером
- `memory_monitor` - монитор памяти
- `browser` - чистый браузер без загруженной страницы

### 3. Добавление тестовых данных

Добавьте константы в `tests/fixtures/test_data.py`:

```python
NEW_TEST_DATA = {
    'expected_value': 42,
    'timeout': 30
}
```

## Лучшие практики

### 1. Используйте явные ожидания

```python
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

WebDriverWait(driver, 10).until(
    EC.presence_of_element_located((By.ID, "element-id"))
)
```

### 2. Обрабатывайте исключения

```python
try:
    element = driver.find_element(By.ID, "element")
except TimeoutException:
    pytest.skip("Element not found - skipping test")
```

### 3. Используйте маркеры для категоризации

```python
@pytest.mark.slow
@pytest.mark.memory
@pytest.mark.integration
def test_long_running_feature():
    pass
```

### 4. Добавляйте информативные сообщения

```python
assert result > 0, f"Expected positive result, got {result}"
```

## Устранение неполадок

### Частые проблемы:

**1. ChromeDriver не найден**
```bash
pip install webdriver-manager  # Автоматически управляет драйверами
```

**2. Тесты падают в headless режиме**
```bash
# Запуск без headless для отладки
CI=false pytest
```

**3. Таймауты при загрузке видео**
```bash
# Увеличить таймауты
TEST_TIMEOUT=60 pytest
```

**4. Проблемы с сетью**
```bash
# Тестирование на локальном сервере
python -m http.server 8000 &
BASE_URL=http://localhost:8000 pytest
```

## Мониторинг и метрики

Тесты собирают следующие метрики:

- **Время загрузки страницы**
- **Время загрузки видео**
- **Использование памяти**
- **Время переходов между видео**
- **Количество ошибок консоли**
- **Сетевые ошибки**

Метрики выводятся в консоль и могут быть сохранены в JSON отчеты.

## Поддержка и развитие

Для добавления новых тестов или улучшения существующих:

1. Изучите существующие тесты как примеры
2. Добавьте соответствующие маркеры
3. Используйте существующие фикстуры и утилиты
4. Добавьте документацию для новых функций
5. Убедитесь, что тесты работают как локально, так и в CI

Для вопросов и предложений создавайте issue в репозитории проекта.
